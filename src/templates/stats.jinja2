{% extends "base_static.jinja2" %}

{% block title %}
    {% trans %}Playback statistics{% endtrans %}
{% endblock title %}

{% block content %}

{{ page_heading(gettext('Playback statistics')) }}

<button id="day">{% trans %}Day{% endtrans %}</button>
<button id="week">{% trans %}Week{% endtrans %}</button>
<button id="month">{% trans %}Month{% endtrans %}</button>
<button id="year">{% trans %}Year{% endtrans %}</button>

<div id="charts">
    {% trans %}Loading charts&mldr;{% endtrans %}
</div>

<link rel="stylesheet" href="/static/lib/toastui-chart-4.6.1.css">
<script src="/static/lib/toastui-chart-4.6.1.js"></script>

<style>
.chart {
    border-radius: var(--border-radius-amount);
    margin-bottom: 1rem;
    overflow: hidden;
}
</style>

<script>
const chartsContainer = document.getElementById('charts');
const buttons = ['day', 'week', 'month', 'year'].map(id => document.getElementById(id));

async function loadCharts(button) {
    // Immediately change buttons and remove old charts for responsiveness
    for (const otherButton of buttons) {
        otherButton.disabled = false;
    }
    button.disabled = true;

    chartsContainer.replaceChildren();

    // Download data
    const response = await fetch('/stats_data?period=' + encodeURIComponent(button.id));
    const json = await response.json();

    // Render charts
    for (const chart of Object.values(json)) {
        const chartElem = document.createElement('div');
        chartElem.style.width = '100%';
        chartElem.style.height = '30rem';
        chartElem.classList.add('chart');
        chartsContainer.append(chartElem);
        const args = {el: chartElem, data: chart['data'], options: chart['options']};
        switch (chart['type']) {
            case 'bar':
                toastui.Chart.barChart(args);
                break;
            case 'column':
                toastui.Chart.columnChart(args);
                break;
            case 'line':
                toastui.Chart.lineChart(args);
                break;
            default:
                throw new Error('invalid type: ' + chart['type']);
                break;
        }
    }
}

document.addEventListener('DOMContentLoaded', () => {
    for (const button of buttons) {
        button.addEventListener('click', () => loadCharts(button));
    }

    loadCharts(buttons[1]);
});

</script>

{% endblock content %}
